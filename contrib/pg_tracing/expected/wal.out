-- Enable wal instrumentation
set pg_tracing.instrument_wal = true;
-- Generate queries with wal write
/*dddbs='postgres.db',traceparent='00-00000000000000000000000000000001-0000000000000001-01'*/ INSERT INTO pg_tracing_test VALUES(generate_series(1, 10), 'aaa');
/*dddbs='postgres.db',traceparent='00-00000000000000000000000000000002-0000000000000002-01'*/ UPDATE pg_tracing_test SET b = 'bbb' WHERE a = 7;
/*dddbs='postgres.db',traceparent='00-00000000000000000000000000000003-0000000000000003-01'*/ DELETE FROM pg_tracing_test WHERE a = 9;
-- Check WAL is generated for the above statements
SELECT trace_id, span_type, span_operation, deparse_info,
       wal_records > 0 as wal_records,
       wal_bytes > 0 as wal_bytes
FROM peek_ordered_spans;
             trace_id             |    span_type    |                          span_operation                          |     deparse_info      | wal_records | wal_bytes 
----------------------------------+-----------------+------------------------------------------------------------------+-----------------------+-------------+-----------
 00000000000000000000000000000001 | Parse           | Parse                                                            |                       |             | 
 00000000000000000000000000000001 | Insert query    | INSERT INTO pg_tracing_test VALUES(generate_series($1, $2), $3); |                       | t           | t
 00000000000000000000000000000001 | Planner         | Planner                                                          |                       | f           | f
 00000000000000000000000000000001 | Executor        | ExecutorRun                                                      |                       |             | 
 00000000000000000000000000000001 | Insert          | Insert on pg_tracing_test                                        |                       | t           | t
 00000000000000000000000000000001 | ProjectSet      | ProjectSet                                                       |                       | f           | f
 00000000000000000000000000000001 | Result          | Result                                                           |                       | f           | f
 00000000000000000000000000000002 | Parse           | Parse                                                            |                       |             | 
 00000000000000000000000000000002 | Update query    | UPDATE pg_tracing_test SET b = $1 WHERE a = $2;                  |                       | t           | t
 00000000000000000000000000000002 | Planner         | Planner                                                          |                       | f           | f
 00000000000000000000000000000002 | Executor        | ExecutorRun                                                      |                       |             | 
 00000000000000000000000000000002 | Update          | Update on pg_tracing_test                                        |                       | t           | t
 00000000000000000000000000000002 | BitmapHeapScan  | BitmapHeapScan on pg_tracing_test                                | Recheck Cond: (a = 7) | f           | f
 00000000000000000000000000000002 | BitmapIndexScan | BitmapIndexScan on pg_tracing_index                              | Index Cond: (a = 7)   | f           | f
 00000000000000000000000000000003 | Parse           | Parse                                                            |                       |             | 
 00000000000000000000000000000003 | Delete query    | DELETE FROM pg_tracing_test WHERE a = $1;                        |                       | t           | t
 00000000000000000000000000000003 | Planner         | Planner                                                          |                       | f           | f
 00000000000000000000000000000003 | Executor        | ExecutorRun                                                      |                       |             | 
 00000000000000000000000000000003 | Delete          | Delete on pg_tracing_test                                        |                       | t           | t
 00000000000000000000000000000003 | BitmapHeapScan  | BitmapHeapScan on pg_tracing_test                                | Recheck Cond: (a = 9) | f           | f
 00000000000000000000000000000003 | BitmapIndexScan | BitmapIndexScan on pg_tracing_index                              | Index Cond: (a = 9)   | f           | f
(21 rows)

CALL clean_spans();
-- Redo the same but without wal instrumentation
set pg_tracing.instrument_wal = false;
/*dddbs='postgres.db',traceparent='00-00000000000000000000000000000001-0000000000000001-01'*/ INSERT INTO pg_tracing_test VALUES(generate_series(1, 10), 'aaa');
/*dddbs='postgres.db',traceparent='00-00000000000000000000000000000002-0000000000000002-01'*/ UPDATE pg_tracing_test SET b = 'bbb' WHERE a = 7;
/*dddbs='postgres.db',traceparent='00-00000000000000000000000000000003-0000000000000003-01'*/ DELETE FROM pg_tracing_test WHERE a = 9;
-- With wal instrumentation disabled, wal counters should be set to 0
SELECT trace_id, span_type, span_operation, deparse_info,
       wal_records = 0 as wal_records,
       wal_bytes = 0 as wal_bytes
FROM peek_ordered_spans;
             trace_id             |    span_type    |                          span_operation                          |     deparse_info      | wal_records | wal_bytes 
----------------------------------+-----------------+------------------------------------------------------------------+-----------------------+-------------+-----------
 00000000000000000000000000000001 | Parse           | Parse                                                            |                       |             | 
 00000000000000000000000000000001 | Insert query    | INSERT INTO pg_tracing_test VALUES(generate_series($1, $2), $3); |                       | t           | t
 00000000000000000000000000000001 | Planner         | Planner                                                          |                       | t           | t
 00000000000000000000000000000001 | Executor        | ExecutorRun                                                      |                       |             | 
 00000000000000000000000000000001 | Insert          | Insert on pg_tracing_test                                        |                       | t           | t
 00000000000000000000000000000001 | ProjectSet      | ProjectSet                                                       |                       | t           | t
 00000000000000000000000000000001 | Result          | Result                                                           |                       | t           | t
 00000000000000000000000000000002 | Parse           | Parse                                                            |                       |             | 
 00000000000000000000000000000002 | Update query    | UPDATE pg_tracing_test SET b = $1 WHERE a = $2;                  |                       | t           | t
 00000000000000000000000000000002 | Planner         | Planner                                                          |                       | t           | t
 00000000000000000000000000000002 | Executor        | ExecutorRun                                                      |                       |             | 
 00000000000000000000000000000002 | Update          | Update on pg_tracing_test                                        |                       | t           | t
 00000000000000000000000000000002 | BitmapHeapScan  | BitmapHeapScan on pg_tracing_test                                | Recheck Cond: (a = 7) | t           | t
 00000000000000000000000000000002 | BitmapIndexScan | BitmapIndexScan on pg_tracing_index                              | Index Cond: (a = 7)   | t           | t
 00000000000000000000000000000003 | Parse           | Parse                                                            |                       |             | 
 00000000000000000000000000000003 | Delete query    | DELETE FROM pg_tracing_test WHERE a = $1;                        |                       | t           | t
 00000000000000000000000000000003 | Planner         | Planner                                                          |                       | t           | t
 00000000000000000000000000000003 | Executor        | ExecutorRun                                                      |                       |             | 
 00000000000000000000000000000003 | Delete          | Delete on pg_tracing_test                                        |                       | t           | t
 00000000000000000000000000000003 | BitmapHeapScan  | BitmapHeapScan on pg_tracing_test                                | Recheck Cond: (a = 9) | t           | t
 00000000000000000000000000000003 | BitmapIndexScan | BitmapIndexScan on pg_tracing_index                              | Index Cond: (a = 9)   | t           | t
(21 rows)

-- Cleanup
set pg_tracing.instrument_wal = true;
CALL clean_spans();
