begin;
-- encourage use of parallel plans
set local parallel_setup_cost=0;
set local parallel_tuple_cost=0;
set local min_parallel_table_scan_size=0;
set local max_parallel_workers_per_gather=2;
-- Trace parallel queries
/*dddbs='postgres.db',traceparent='00-00000000000000000000000000000001-0000000000000001-01'*/ select 1 from pg_class limit 1;
 ?column? 
----------
        1
(1 row)

/*dddbs='postgres.db',traceparent='00-00000000000000000000000000000002-0000000000000002-01'*/ select 2 from pg_class limit 2;
 ?column? 
----------
        2
        2
(2 rows)

/*dddbs='postgres.db',traceparent='00-00000000000000000000000000000003-0000000000000003-00'*/ select 3 from pg_class limit 3;
 ?column? 
----------
        3
        3
        3
(3 rows)

commit;
-- Worker can take some additional time to end and report their spans
SELECT pg_sleep(0.1);
 pg_sleep 
----------
 
(1 row)

-- Check order and number of spans generated by parallel queries
-- We can't order by span start due to the parallelisation introducing randomness
SELECT name, resource from pg_tracing_consume_spans order by resource;
    name    |             resource              
------------+-----------------------------------
 Executor   | End
 Executor   | End
 Executor   | End
 Executor   | End
 Executor   | End
 Executor   | End
 Executor   | Finish
 Executor   | Finish
 Executor   | Finish
 Executor   | Finish
 Executor   | Finish
 Executor   | Finish
 Gather     | Gather
 Gather     | Gather
 Limit      | Limit
 Limit      | Limit
 SeqScan    | Parallel SeqScan on pg_class
 SeqScan    | Parallel SeqScan on pg_class
 SeqScan    | Parallel SeqScan on pg_class
 SeqScan    | Parallel SeqScan on pg_class
 SeqScan    | Parallel SeqScan on pg_class
 SeqScan    | Parallel SeqScan on pg_class
 Parse      | Parse
 Parse      | Parse
 Planner    | Planner
 Planner    | Planner
 Post Parse | Post Parse
 Post Parse | Post Parse
 Executor   | Run
 Executor   | Run
 Executor   | Run
 Executor   | Run
 Executor   | Run
 Executor   | Run
 Executor   | Start
 Executor   | Start
 Executor   | Start
 Executor   | Start
 Executor   | Start
 Executor   | Start
 Select     | Worker 0
 Select     | Worker 0
 Select     | Worker 1
 Select     | Worker 1
 Select     | select $1 from pg_class limit $2;
 Select     | select $1 from pg_class limit $2;
(46 rows)

